#!/usr/bin/env node

var sys = require('sys'),
    path = require('path'),
    fs = require('fs'),
    argv = require('optimist').argv,
    Content = require('../server/content'),
    assets = require('../server/assets'),
    server = require('../server/server');

var help = [
    "",
    "usage:".underline,

    "  start [options]                                                  ",
    "                                                                   ",

    "options:".underline,

    "  -s --silent    Suppress the log messages from the output           ",
    "  -d --download  Download the hole org before launching server       ",
    "  -h, --help     This is it!                                         ",
    ""
].join('\n');

if (argv.h || argv.help) {
  return console.log(help);
}

var conf = JSON.parse(fs.readFileSync('./server/conf.json'));

['orgname', 'giturl', 'tagline'].forEach(function(val, index) {
  if(!conf[val]) {
    throw new Error('start requires `' + val + '` from the `conf.json` file.');
  }
});

var config = {
  "orgname": conf.orgname,
  "giturl": conf.giturl,
  "tagline": conf.tagline,
  "port": argv.p || argv.port || 8080,
  "host": argv.h || argv.host || '127.0.0.1'
};

var content = new Content();

function afterDownload() {
  content.loadRepos(function(err) {
    Object.keys(content.repos).forEach(function(repoName) {
      console.log('meta for %s: %j', repoName, content.repos[repoName].meta);
    })
    if (err) { throw err; }
    content.compose(assets, content.repos);
    server.createServer(content, config);
  });
}

if (argv.d) {
  content.downloadAll(afterDownload);
} else {
  afterDownload();
}