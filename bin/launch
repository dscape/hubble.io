#!/usr/bin/env node

// if (process.env.NODE_ENV !== 'production') {
//   process.logging = function(module) {
//     return function() {
//       console.log('[' + module + '] ', arguments);
//     };
//   };
// }

var sys = require('sys'),
    path = require('path'),
    fs = require('fs'),
    argv = require('optimist').argv,
    server = require('../server/server'),
    Content = require('../lib/content'),
    conf = require('konphyg')(__dirname + '/../config')('conf');
    
var help = [
    "",
    "usage:".underline,

    "  start [options]                                                  ",
    "                                                                   ",

    "options:".underline,

    "  -s --silent    Suppress the log messages from the output           ",
    "  -c --cache     Use local cache, don't download repos from GitHub   ",
    "  -h, --help     This is it!                                         ",
    ""
].join('\n');

if (argv.h || argv.help) {
  return console.log(help);
}

['orgname', 'tagline'].forEach(function(val, index) {
  if(!conf[val]) {
    throw new Error('start requires `' + val + '` from the `conf.json` file.');
  }
});

var config = {
  "orgname": conf.orgname,
  "tagline": conf.tagline,
  "title": conf.title,
  "content": conf.content,
  "auth": conf.auth,
  "port": argv.p || argv.port || 8080,
  "host": argv.h || argv.host || '127.0.0.1',
  "db": conf.db,
  "email": conf.email,
  "session": conf.session
};

var download = ! argv.c;

Content(config, download, function(err, content) {
  if (err) { throw err; }
  console.log('Content loaded');
  server.createServer(config, content);
});
